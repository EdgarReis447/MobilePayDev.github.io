---
sidebar_position: 2
---

import Tabs from '@theme/Tabs'
import TabItem from '@theme/TabItem'

# Build on Android

This page details how MobilePay In-App payments should be implemented in your Android app.

## Prerequisites and assumptions

- Prerequisites:
  - Your app uses [minSdkVersion](https://developer.android.com/training/basics/supporting-devices/platforms.html#sdk-versions) API 23 (Marshmallow, 6.0) or later.
- This guide assumes:
  - You already have backend services for functions described [here](https://mobilepaydev.github.io/MobilePay-Payments-API/docs/guides/in-app-payments/how-it-works).
  - You are generally familiar with developing applications on Android.

:::caution Make sure you are compliant with mobile application distribution service rules!
Using In-App Payments for digital sales might not be allowed by some mobile application distribution services (Google Play, App Store, etc.) and might result in your application being removed. Please review the terms of service for the respective mobile application distribution services you use to ensure that you are compliant with their guidelines.
:::

## Initiate the payment

First, you'll need to initiate the payment. To do this you should call your backend service that is implemented as described [here](https://mobilepaydev.github.io/MobilePay-Payments-API/docs/payments-refunds/take-payments). This service call should return a response that contains a deep link needed to launch the MobilePay app.

## Redirect to MobilePay

Now that we have the deep link let's open the MobilePay app:

<Tabs
  defaultValue="kotlin"
  values={[
    { label: 'Kotlin', value: 'kotlin', },
    { label: 'Java', value: 'java', },
  ]
}>
<TabItem value="kotlin">

```kotlin
fun openMobilePay(deepLink: String) {
    try {
        val intent = Intent(Intent.ACTION_VIEW).apply {
            data = Uri.parse(deepLink)
        }
        startActivity(intent)
        // At this point we know that MobilePay will be launched.
        // Consider navigating to a new screen here.
    } catch (exception: ActivityNotFoundException) {
        // Inform the user that MobilePay is not installed.
    }
}
```

</TabItem>

<TabItem value="java">

```java
void openMobilePay(String deepLink) {
    try {
        Intent intent = new Intent(Intent.ACTION_VIEW);
        intent.setData(Uri.parse(deepLink));
        startActivity(intent);
        // At this point we know that MobilePay will be launched.
        // Consider navigating to a new screen here.
    } catch (android.content.ActivityNotFoundException exception) {
        // Inform the user that MobilePay is not installed.
    } catch (NullPointerException exception) {
        // Null deepLink was passed in.
    }
}
```

</TabItem>
</Tabs>

After this, the MobilePay app will be launched and the user will be able to proceed with the payment flow.

## Returning to your app

There are multiple ways the user can return to your app:

- User approves the payment and is redirected back to your app.
- User cancels the payment and is redirected to your app.
- User fails to complete the payment due to some kind of error and is redirected to your app.
- User closes the app before/after reservation using the native app switcher.
- User presses back in the MobilePay Login screen.

All these we can group into:

- App switching.
- Redirect.

Let's see how each one should be handled.

### App switching

At any point, the user can close the MobilePay app and just return to your app. **This can happen even if payment is already reserved!** Because it is unknown if your app was opened after completed payment, you'll need to check the payment status each time your app returns to the foreground. For this, you should use your backend service that provides the current status of the payment (more details [here](/docs/payments-refunds/take-payments)).

These are the statuses this service could possibly return:

- Initiated - payment is still in the initiated state. It means that the user closed the app manually without doing any action. Consider adding a way for the user to invoke the deep link again (for example a button to open MobilePay) or just treat it as canceled.
- Canceled - user canceled the payment or payment is unable to succeed due to some error.
- Reserved - user successfully completed the MobilePay flow and payment is reserved.
- Captured - payment is successfully captured.

If your flow requires payments to be captured (not just reserved), consider polling the status checking service while status is "Reserved".

### Redirect from MobilePay

The other scenario is that the MobilePay app tries to automatically navigate back to your app. For this to work you'll need:

- Valid deep link to a place that knows how to proceed with the flow ([official deep linking guide](https://developer.android.com/training/app-links/deep-linking)).
- Provide this deep link during [payment initiation](#initiate-the-payment).

In the general case, this deep link should open the app screen which handles the "App switching" scenario described above, and just treat it the same way as if the user manually navigated to your app.

:::tip Want to make the flow faster?
When redirecting back to your app, the MobilePay app appends a query parameter named "status" to the end of the deep link. It can contain these values:

- successful
- failed
- rejected

If you want the maximum speed to consider checking this parameter and triggering a capture without checking the status in your backend (capture can only succeed if payment is reserved).
:::

## All done

Now everything should be ready for testing! Sandbox testing guide is [here](https://sandbox-developer.mobilepay.dk/).

:::caution Make sure you are using the correct MobilePay app!
MobilePay supports multiple countries, but cross-country payments are not enabled.
:::

Having troubles with this guide? Be sure to contact us!
